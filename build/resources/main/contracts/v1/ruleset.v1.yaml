kind: RULESET
id: ruleset.core.v1
version: 1.0.0
status: ACTIVE

entityType: PRODUCT

impactMap:
  CORE:
    - "/title"
    - "/brand"
    - "/price"
  PRICE:
    - "/price"
    - "/salePrice"
    - "/discount"
  INVENTORY:
    - "/stock"
    - "/availability"
  MEDIA:
    - "/images"
    - "/videos"
  CATEGORY:
    - "/categoryId"
    - "/categoryPath"
  PROMOTION:
    - "/promotionIds"
    - "/couponIds"
  REVIEW:
    - "/reviewCount"
    - "/averageRating"

joins: []

slices:
  - type: CORE
    buildRules:
      type: PassThrough
      fields:
        - "*"
    # RFC-IMPL-010 GAP-B: Light JOIN 예시
    # 실제 운영에서는 brandId로 BRAND 엔티티 조회하여 payload에 병합
    joins:
      - name: brandInfo
        type: LOOKUP
        sourceFieldPath: brandId
        targetEntityType: BRAND
        targetKeyPattern: BRAND#{tenantId}#{value}
        required: false  # 브랜드 없어도 슬라이싱 진행
  - type: PRICE
    buildRules:
      type: PassThrough
      fields:
        - "price"
        - "salePrice"
        - "discount"
  - type: INVENTORY
    buildRules:
      type: PassThrough
      fields:
        - "stock"
        - "availability"
  - type: MEDIA
    buildRules:
      type: PassThrough
      fields:
        - "images"
        - "videos"
  - type: CATEGORY
    buildRules:
      type: PassThrough
      fields:
        - "categoryId"
        - "categoryPath"

# RFC-IMPL-010 Phase D-9: Inverted Index 정의 (통합 버전)
# references: FK 엔티티 타입 → 역방향 인덱스 자동 생성 (Fanout용)
# maxFanout: circuit breaker 임계값 (기본값: 10000)
indexes:
  - type: brand
    selector: $.brandId      # EntityKey 형식: "BRAND#tenant#entityId" 또는 entityId만
    references: BRAND        # Brand 변경 시 → 연관 Product 자동 재슬라이싱
    maxFanout: 10000
  - type: category
    selector: $.categoryId
    references: CATEGORY     # Category 변경 시 → 연관 Product 자동 재슬라이싱
    maxFanout: 50000        # 카테고리는 연관 상품이 많을 수 있음
  - type: tag
    selector: $.tags[*]
    # references 없음 → 검색용 인덱스만 생성 (Fanout 없음)
