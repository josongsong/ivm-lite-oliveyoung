RFC-V4-006 — Slicing Join 허용 범위 및 중간 IR 정의

Slicing Join 허용 범위 및 중간 IR 정의

Status: Draft
Created: 2026-01-25
Scope: v4 Slicing Layer
Depends on: RFC-V4-001, RFC-V4-002, RFC-V4-003
Audience: Platform / Architecture / Contract Authors
Non-Goals: 다대다 join 허용, 런타임 탐색형 join, 중간 IR을 별도 레이어로 분리

0. Executive Summary

본 RFC는 slicing 단계에서의 join 허용 범위, 중간 IR의 정의 방식, 계약(Contract)로 고정해야 할 불변식을 명확히 규정함.
결론은 다음과 같음.

slicing에서 가벼운 join은 허용함

join은 타입·상한·선택 규칙이 계약으로 고정되어야 함

“중간 IR”은 새 레이어가 아니라 SliceType의 한 종류로 정의함

RefIndexSlice / EnrichmentSlice 패턴을 표준으로 채택함

View에서는 최종 조합 1회만 허용함

1. 배경과 문제 정의
1-1. 문제

slicing에서 join을 전면 금지하면 Slice 수가 과도하게 증가함

반대로 join을 무제한 허용하면 결정성·증분·영향 분석이 붕괴됨

“중간 IR을 따로 둬야 하나?”에 대한 설계 기준이 불명확했음

1-2. 목표

slicing 단계에서 안전한 범위의 join만 허용

join으로 인해 생기는 중간 산출물의 지위를 명확히 정의

증분(ChangeSet)·재빌드·확장 시 설계가 흔들리지 않도록 계약화

2. 핵심 개념 정의
2-1. Artifact Kind

RawData: 원천 입력(정규화·해싱됨)

Slice: 읽기 최적화 산출물 (여기에 “중간 IR 역할 Slice” 포함)

View: 런타임 최종 응답 조합

※ “중간 IR”은 별도 레이어가 아니라 Slice의 한 subtype임

2-2. SliceType 분류

**기본 SliceType** (RFC-001):
- CoreSlice: join 금지 (SliceType: CORE)
- VariantSlice: join 금지 (SliceType: VARIANT)
- DiscoverySlice: join 금지 (SliceType: DISCOVERY)
- PolicySlice: join 금지 (SliceType: POLICY)
- ContentIndexSlice: join 금지 (SliceType: CONTENT_INDEX)

**중간 IR SliceType** (RFC-006):
- RefIndexSlice: lookup 전용 slice (중간 IR 역할, SliceType: REF_INDEX)
- EnrichmentSlice: 제한적 join 허용 slice (SliceType: ENRICHMENT)

**컴파일러 SliceType** (RFC-009):
- Target: 최종 서빙용 slice (SliceType: TARGET)

3. slicing 단계에서 join 허용 원칙
3-1. 허용되는 join

1:1 또는 1:small-N (상한이 계약으로 고정됨)

사전 계산된 snapshot/RefIndexSlice 기반 lookup

결정적 선택 규칙(pick rule)이 명시된 경우

**RFC-001과의 일관성**: 
- MANY_TO_ONE / ONE_TO_ONE만 허용 (RFC-001: 10-1)
- fanout cardinality 상한: 1:N 허용, N:M 금지 (RFC-001: 10-1-1)
- join depth = 1 (단일 홉 LOOKUP만 허용) (RFC-001: 10-1-1)

3-2. 금지되는 join

다대다 join (카디널리티 폭발) - N:M 금지 (RFC-001: 10-1-1)

외부 상태(user/session/실시간) 결합

탐색형/조건형 런타임 쿼리

상한·선택 규칙이 없는 join

**추가 금지 사항 (RFC-001: 10-1-1)**:
- chain join 금지 (순환/연쇄 조인 금지)
- 순환 참조 및 다단계 조인 금지

4. 중간 IR의 공식 정의 방식
4-1. 레이어 분리 금지

ir/ 같은 새로운 레이어를 만들지 않음

중간 표현은 SliceType으로만 존재함

4-2. RefIndexSlice (표준 중간 IR)

목적: 다른 Slice가 lookup하기 위한 정규화된 참조

예시

BrandSummarySlice

CategoryPathSlice

PricePolicySlice

특징

다수 consumer slice에서 재사용됨

변경 영향 범위가 명확함

증분/재빌드 계산이 쉬움

4-3. EnrichmentSlice (결과 확장)

EnrichmentSlice는 다음 중 하나 이상의 조합:
- CoreSlice + RefIndexSlice (권장, v1+)
- CoreSlice + RawData (직접 join, 제한적, v0)
- CoreSlice + RefIndexSlice + RawData (혼합, 제한적)

표시용 소량 필드 embed만 허용

**RFC-009와의 일관성**:
- EnrichmentSlice는 AggregationRule의 materializeSlice로 사용 가능 (RFC-009: 2-3)
- provides/requires는 Capability 기반으로 표현되며, 실제 구현은 JoinSpec으로 매핑됨 (RFC-009: 2-2)

**RFC-001과의 일관성**:
- Join 결과는 Slice에 물리화 (RFC-001: 10-1)
- View에서 재조인 금지 (RFC-001: 10-1)
- Join으로 생성된 SliceType도 ImpactMap에 포함 (RFC-001: 9-2)

**Inverted Index 연계 (RFC-001: 17-8)**:
- Join으로 생성된 Slice도 index source가 될 수 있음
- Join 대상 변경 시: ChangeSet(brand) → JoinSpec impact → EnrichmentSlice 재생성 → 해당 index 재생성

5. JoinSpec 계약 (필수)
5-1. JoinSpec 필수 필드

sourceSliceType

maxRows (카디널리티 상한) - RFC-001의 fanout cardinality 상한과 일치

pickRule (결정적 선택 규칙)

required (missing 허용 여부)

versioningRule (참조 버전 고정 규칙) - RFC-001의 refVersion 개념과 일치

**RFC-001과의 일관성**:
- joinSources, entityType, keyResolver (RFC-001: 10-2)
- joinProjection (포함 필드 명시) (RFC-001: 10-2)
- joinImpact (참조 엔티티 변경 시 영향 SliceType) (RFC-001: 10-2)

**계약 검증 규칙 (RFC-001: 10-1-1)**:
- JoinSpec 계약 검증 시점에 제한 사항 강제
- 위반 시 계약 로드 실패 (fail-closed)
- JoinSpec 허용 범위는 계약 스키마에 명시적으로 포함되어야 함

5-2. JoinSpec 예시(개념)

ProductEnrichedSlice는 BrandSummarySlice를

maxRows = 1

pickRule = LatestActive

required = false

versioningRule = SameVersion (동일 version 기본, RFC-001: 10-2)

joinImpact = [CORE, DISCOVERY] (영향받는 SliceType 목록)

로 참조함

**RFC-009와의 일관성**:
- JoinSpec은 SliceDescriptor의 `joinSpecs` 필드에 포함됨 (RFC-009: 7-1)
- 각 JoinSpec은 하나 이상의 Capability를 provides로 매핑됨 (예: `join.brand`)
- provides는 JoinSpec의 추상화된 표현이며, 실제 구현은 joinSpecs에 명시됨 (RFC-009: 2-2)

※ JoinSpec는 ContractRegistry에 등록되어야 함 (RFC-001: 10-2-1)

6. View 단계의 join 규칙
6-1. 원칙

View에서의 join은 최종 조합 1회만 허용

View는 slicing 결과를 조합할 뿐, 의미 계산을 하지 않음

6-2. slicing vs view 역할 분리

slicing: 구조적/결정적 embed (소량)

view: 페이지/응답 단위 조합

7. 증분(ChangeSet)과의 연계
7-1. RefIndexSlice의 장점

Brand 변경 → BrandSummarySlice만 재빌드

이를 참조하는 EnrichmentSlice만 영향받음

전체 ProductSlice 재빌드 방지 가능

**RFC-001과의 연계**:
- ChangeSet에 fanout_source 명시 (RFC-001: 7-3)
- JoinSpec impact를 통한 영향 범위 계산 (RFC-001: 10-2)
- ImpactMap을 통한 ImpactedSliceSet 계산 (RFC-001: 9-2)

7-2. JoinSpec 기반 영향 계산

어떤 SliceType이 어떤 RefIndexSlice에 의존하는지 명시됨

ChangeSet → Impacted SliceType 계산 가능

**RFC-001 보완 사항 반영**:
- JoinSpec의 joinImpact 필드가 명시적으로 영향받는 SliceType을 선언 (RFC-001: 10-2)
- 명시되지 않은 Join 영향은 FAIL_CLOSED (RFC-001: 10-2)
- Inverted Index를 통한 fanout 계산 시 JoinSpec 영향 반영 (RFC-001: 17-8)

**7-3. Diff 계산과 RefIndexSlice 연계 (P0, 필수)**

**Impact Resolver 동작**:
- RefIndexSlice 변경 시: JoinSpec reverse index 조회 → 영향받는 EnrichmentSlice 목록 산출
- EnrichmentSlice 변경 시: ViewDefinition 조회 → 영향받는 View 목록 산출
- CoreSlice 변경 시: 자신의 RawData 타입 변화에만 영향

**핵심 규칙**:
- RefIndexSlice가 바뀌면, 이를 참조하는 EnrichmentSlice만 영향
- join이 들어간 slice는 항상 "역참조 인덱스"가 필요 (RFC-001: 9-3-2)
- Diff 계산은 "필드 나열"이 아니라 "Impact Graph"로 산출 (RFC-001: 9-1-1)

8. v0 / v1 적용 가이드
8-1. v0 (단순)

inline enrichment 허용(극소수)

JoinSpec 타입은 미리 정의

RefIndexSlice는 optional

8-2. v1+ (확장)

RefIndexSlice 공식 도입

EnrichmentSlice / CoreSlice 명확 분리

ChangeSet과 자동 영향 계산 연결

9. 금지 사항 요약

slicing에서 다대다 join 금지

slicing에서 런타임 탐색형 join 금지

중간 IR을 새로운 레이어로 분리 금지

JoinSpec 없는 join 금지

10. 결정 사항 요약

slicing 단계에서 제한적 join을 허용함

join은 JoinSpec 계약으로만 정의됨

중간 IR은 SliceType의 한 종류로 정의됨

RefIndexSlice / EnrichmentSlice 패턴을 표준으로 채택함

View는 최종 조합 1회만 수행함

**10-1. RFC-001~005와의 일관성**

본 RFC는 RFC-001의 JoinSpec 보완 사항과 완전히 일치함:
- JoinSpec 금지 규칙 (fanout cardinality, join depth, 순환 참조) (RFC-001: 10-1-1)
- JoinSpec 계약 검증 및 fail-closed 정책 (RFC-001: 10-2-1)
- ChangeSet와의 연계 (fanout_source, joinImpact) (RFC-001: 7-3, 10-2)
- Inverted Index와의 연계 (Join 대상 변경 시 영향 계산) (RFC-001: 17-8)

**10-2. 구현 고려사항**

RefIndexSlice는 Inverted Index의 참조 대상이 될 수 있음 (RFC-001: 17-8)

EnrichmentSlice 생성 시 JoinSpec의 versioningRule에 따라 refVersion 명시 필요 (RFC-001: 17-3-1)

JoinSpec은 Contract Registry에 등록되어 계약 검증 시점에 검증됨 (RFC-003: 2-7)
