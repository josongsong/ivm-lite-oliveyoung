RFC-V4-010 — Repository Layout, Naming, and Guardrails

Orchestration-First Entry + Domain-Only Meaning (SOTA Conventions)

Status: Accepted
Created: 2026-01-25
Scope: ivm-lite Repo / Package Layout / Naming / Guardrails
Depends on: RFC-V4-003, RFC-V4-005, RFC-V4-007, RFC-V4-008
Audience: Platform / Architecture / All Contributors
Non-Goals: 멀티모듈 강제, 런타임 프레임워크(HTTP/DI) 확정, 린터/정적분석 도구 선택 강제

0. Executive Summary

본 RFC는 ivm-lite 레포의 **폴더 구조·네이밍·경계(가드레일)** 를 SSOT로 고정한다.
핵심 원칙은 “SOTA 관행”에 맞게 **외부 진입은 orchestration**, **도메인 내부는 의미/정책**, **apps는 트리거(어댑터)** 로 역할을 분리하는 것이다.

- 관측/트랜잭션/재시도/타임아웃/보상(compensation) 같은 **실행 정책을 한 계층에서 잡기**
- 도메인 간 결합을 **기계적으로 방지**
- “여기엔 뭘 둬야 하지?”를 없애서 개발 속도와 품질을 동시에 올리는 것

**핵심 결론**:
- **외부 진입점은 orchestration만 호출한다** (apps/cli/worker는 트리거)
- **cross-domain workflow는 orchestration만 소유한다**
- orchestration은 **도메인 기능(service/port/step)을 조합**한다. UseCase-of-UseCase는 최소화하고 호출 깊이를 제한한다.
- 비즈니스 의미/정책은 domain/service에만 둔다. orchestration은 흐름·경계·실행 정책만 소유한다.
- 호출되는 단위는 “UseCase”가 아니라 **Step/Activity/Command/Task**로 의미를 분리한다. (호출은 하되 유스케이스로 부르지 않는다)

---

1. 용어 정의

1-1. Domain
- 비즈니스 의미/정책/불변식을 소유하는 단위 (예: rawdata, slices)

1-2. Orchestration (Workflow)
- 여러 도메인 기능을 **순서·경계·실행 정책**에 따라 조합하는 “흐름”의 소유자
- 관측(로그/트레이싱), 트랜잭션 경계, retry/timeout/compensation 같은 실행 정책의 SSOT
- 비즈니스 결과를 “계산”하지 않는다(의미/정책은 domain/service로). 단, 실행 정책은 orchestration/step이 가진다.

1-3. Apps (Trigger / Entry)
- HTTP/CLI/Worker/Event subscriber 등 **외부 트리거를 받아 orchestration을 호출**하는 계층
- 비즈니스 의미 로직을 소유하지 않는다 (RFC-V4-007 금지 패턴 준수)

1-4. Tooling
- 개발/테스트 단계에서만 쓰는 DX 도구 (validate/codegen/simulate/diff/replay 등)

---

2. 최상위 레포 구조 (SSOT)

2-1. v0 단일 모듈(현재) 구조

```
ivm-lite/
  docs/
    rfc/
      rfc010.md
      ...

  src/main/kotlin/com/oliveyoung/ivmlite/
    shared/                      # 공통 코어(결정성/에러/타입/공통 포트)
    package/                     # 도메인 그룹
      rawdata/
      changeset/
      contracts/
      slices/
      orchestration/             # cross-domain workflow + steps (SSOT)
    tooling/                     # DX 도구
    apps/                        # 트리거/엔트리포인트
      runtimeapi/                # (추후) http/worker 등
      opscli/                    # 운영 CLI

  src/test/kotlin/com/oliveyoung/ivmlite/
    ...
```

2-2. v1+ 멀티모듈 승격(미래, 선택)
- 폴더 트리는 그대로 Gradle 모듈로 승격 가능해야 한다 (RFC-V4-005 원칙).

---

3. `shared/` 규칙 (P0)

3-1. shared가 포함할 수 있는 것(허용)
- 결정성 유틸: canonical json, hashing, deterministic ordering
- 공통 에러 모델: DomainError 계열
- 공통 타입: TenantId, EntityKey, SemVer 등
- 공통 포트: SingleFlightPort, (추후) ClockPort/ObservabilityPort/TenantValidatorPort 등

3-2. shared가 포함하면 안 되는 것(금지)
- rawdata/changeset/slices/view/sink의 “의미 로직”
- 특정 도메인의 정책/규칙/워크플로우

---

4. `package/<domain>/` 구조 규칙

4-1. 레이어 고정 (RFC-V4-005 확장)
- `domain/`: 순수 의미 모델 + 불변식 + 순수 계산
- `ports/`: 외부 의존 계약(인터페이스)
- `adapters/`: 인프라 구현 (DB/registry/messaging 등)
- `application/`: **single-domain façade**(선택)
  - 외부 진입점 아님 (orchestration에서만 호출)

4-2. 도메인 간 import 금지 (P0)
- `package/rawdata/**` 가 `package/slices/**` 를 직접 import 금지
- 도메인 간 호출/데이터 접근은 **ports 계약**을 통해서만

4-3. single-domain application 허용 범위(권장)
- “해당 도메인 내부 정책/불변식 중심”이면 `package/<domain>/application/` 허용
- cross-domain이 되는 순간 `package/orchestration/`로 승격

---

5. `package/orchestration/` 규칙 (P0)

5-1. 목적
- **cross-domain workflow의 SSOT**
- 관측/트랜잭션 경계/timeout/retry/compensation의 SSOT

5-2. 내부 구조(권장)

**v0 단일 모듈(현재): orchestration은 hexagonal 계층을 갖지 않음**

orchestration이 "도메인 정책"을 갖지 않으므로(흐름/순서/실행 정책만 담당), 
현재는 파일만 배치하고 폴더 구조는 최소화:

```
package/orchestration/
  ├── IngestWorkflow.kt
  ├── SlicingWorkflow.kt
  └── QueryViewWorkflow.kt
```

**v1+ 이후: 필요해지면 구조 추가**

orchestration이 복잡한 정책/규칙이나 상태 머신을 가지게 되면:

```
package/orchestration/
  application/
    *Workflow.kt          # 외부 진입점
  steps/
    *Step.kt              # 내부 step (재사용 단위)
  domain/                 # (필요시) 정책/규칙/상태 머신
  ports/                  # (필요시) orchestration 전용 포트
    (예: ObservabilityPort, TransactionCoordinatorPort)
```

**원칙**: 복잡도가 실제로 생기기 전까지 폴더 구조를 추가하지 않는다 (YAGNI).

5-3. 네이밍 규칙(강제)

**v0 (현재)**:
- 파일명: `*Workflow.kt` (외부 진입점)
- 예: `IngestWorkflow.kt`, `SlicingWorkflow.kt`, `QueryViewWorkflow.kt`

**v1+ (필요시)**:
- 외부 진입점: `*Workflow` 또는 `*Orchestration`
- 내부 step: `*Step` / `*Activity` / `*Command`
- 예: `ValidateContractsStep`, `PersistRawDataStep`, `BuildSlicesStep`

5-4. UseCase-of-UseCase 최소화(강제)
- orchestration → orchestration 호출 금지
- workflow가 다른 workflow를 호출하는 중첩 금지 (깊이 제한)
- 권장 깊이:
  - `workflow -> step/service`
  - `step -> domain service/port`
  - 그 이상 중첩 금지

5-5. “정책의 위치” 규칙(권장)
- 도메인 정책(의미/규칙): domain/service 쪽
- 실행 정책(timeout/retry/backoff/compensation/transaction): orchestration/step 쪽

---

6. `apps/` 규칙 (P0)

6-1. 역할
- 외부 트리거(HTTP/CLI/worker/event)를 받아 **orchestration workflow를 호출**
- DI(wiring)와 직렬화/역직렬화, 인증/인가 같은 “어댑터” 책임만

6-2. 금지 사항 (RFC-V4-007 일관)
- apps에서 비즈니스 의미 로직 구현 금지
- apps에서 도메인 간 조합을 직접 구현 금지 (반드시 orchestration으로)

---

7. `tooling/` 규칙

7-1. 역할
- 개발/테스트/CI 단계에서만 사용하는 도구 제공
- 런타임 경로의 SSOT가 아님 (런타임 로직 복제 금지)

7-2. 예시
- `validate-contracts`: 계약 파일 검증
- (추후) codegen/simulate/diff/replay

---

8. Naming Convention (SSOT)

8-1. 패키지/디렉토리
- 최상위: `shared`, `package`, `tooling`, `apps`
- 도메인: 단수 소문자 (rawdata, changeset, contracts, slices, orchestration)

8-2. 클래스

**도메인**:
- domain: 명사/값 객체 중심 (`RawDataRecord`, `SliceRecord`)
- ports: `*Port` 접미 (`RawDataRepositoryPort`)
- adapters: `*Adapter` 또는 기술명 접미 (`InMemoryRawDataRepository`)

**Orchestration**:
- v0 (현재): `*Workflow` (IngestWorkflow, SlicingWorkflow, QueryViewWorkflow)
- v1+ (필요시):
  - 외부 진입: `*Workflow`
  - 내부 step: `*Step` / `*Activity` / `*Command`

---

9. Guardrails (Enforcement)

9-1. 코드 리뷰 체크리스트 (P0)
- cross-domain 조합이 `package/orchestration` 밖에 존재하는가? → 즉시 이동
- 도메인 간 직접 import가 생겼는가? → 즉시 차단
- apps가 orchestration 대신 도메인을 직접 조합하는가? → 즉시 차단

9-2. 정적 분석(추후, 권장)
- Detekt/ktlint 커스텀 룰로 “금지 import”를 기계적으로 막는다
- 예: `package/<domain>/`에서 다른 `package/<domain2>/` import 금지
- 예: orchestration → orchestration import/호출 금지
- 예: apps → domain 직접 호출/조합 금지 (orchestration만 호출)

---

10. 마이그레이션 가이드

10-1. 새 기능 추가 순서(권장)
- domain 모델/불변식 추가 → ports 정의 → adapters 구현 → orchestration workflow/step로 조합 → apps에서 트리거만 연결

10-2. 파일이 어디로 가야 하는지 애매할 때
- “이 코드가 **흐름/순서/경계**를 소유하는가?” → orchestration
- “이 코드가 **의미/정책/불변식**을 소유하는가?” → domain/service
- “이 코드가 **외부 입출력/트리거**를 소유하는가?” → apps
- “이 코드가 **DX/CI 전용 도구**인가?” → tooling

---

11. Final Judgment

이 RFC는 ivm-lite의 레포/폴더/네이밍을 “기계적으로” 고정하여:

- cross-domain 결합을 사전에 차단하고
- 관측/트랜잭션/재시도 같은 실행 정책을 한 곳에서 통제하며
- 팀이 확장 가능한 구조로 일관되게 개발할 수 있도록 한다.

채택 후 변경은 RFC 절차를 따른다.

한 줄 요약:
외부는 orchestration만 부른다. 의미는 domain에만 둔다. 흐름과 실행 정책은 orchestration이 소유한다.
