kind: JoinSpecContract
id: join-spec.v1
version: 1.0.0
status: ACTIVE

definition:
  meaning: Lightweight single-hop lookup join for slice compilation
  joinIsNotPersisted: true
  joinResultsMustNotBeMaterialized: true

constraints:
  allowedJoinTypes: [LOOKUP]
  maxJoinDepth: 1
  forbidJoinChain: true
  forbidCycles: true
  forbidNMJoin: true
  sourceCardinality: SINGLE
  maxJoinTargetsPerSource: 1
  requireDeterministicResolution: true

inputs:
  sourceEntityType: { type: enum, values: [PRODUCT, BRAND, CATEGORY] }
  sourceFieldPath: { type: string, rule: RFC6901_JSON_POINTER }

target:
  targetEntityType: { type: enum, values: [BRAND, CATEGORY] }
  targetKeyPattern: { type: string }
  required: { type: boolean, default: true }
  missingPolicy: { type: enum, values: [FAIL_CLOSED, PARTIAL_ALLOWED], default: FAIL_CLOSED }

projection:
  mode: { type: enum, values: [COPY_FIELDS], default: COPY_FIELDS }
  fields:
    type: array
    items:
      fields:
        fromTargetPath: { type: string, rule: RFC6901_JSON_POINTER }
        toOutputPath: { type: string, rule: RFC6901_JSON_POINTER }

fanout:
  # DEPRECATED: invertedIndex.contractRef는 더 이상 사용되지 않습니다.
  # 역방향 인덱스는 RuleSet.indexes의 IndexSpec.references로 통합되었습니다.
  # 아래 설정은 하위 호환성을 위해 유지되지만 무시됩니다.
  invertedIndex:
    required: false  # deprecated: 더 이상 필수 아님
    # contractRef: { id: inverted-index.v1, version: 1.0.0 }  # removed
    maxFanout: 10000  # 이제 IndexSpec.maxFanout으로 이동
  joinDepReason: JOIN_DEP

determinism:
  canonicalJsonProfile: RFC8785
  hashAlg: sha256
  ordering:
    joinResult: DECLARED_ORDER

runtimeGuards:
  forbidTimeSemantics: true
  forbidMaterializeJoin: true
  maxReadAttempts: 5
