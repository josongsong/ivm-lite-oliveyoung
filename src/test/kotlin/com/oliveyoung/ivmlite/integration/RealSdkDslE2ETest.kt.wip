package com.oliveyoung.ivmlite.integration

import com.oliveyoung.ivmlite.apps.runtimeapi.module
import com.oliveyoung.ivmlite.pkg.orchestration.application.IngestWorkflow
import com.oliveyoung.ivmlite.pkg.orchestration.application.QueryViewWorkflow
import com.oliveyoung.ivmlite.pkg.orchestration.application.SlicingWorkflow
import com.oliveyoung.ivmlite.pkg.rawdata.ports.OutboxRepositoryPort
import com.oliveyoung.ivmlite.sdk.Ivm
import com.oliveyoung.ivmlite.sdk.client.IvmClientConfig
import com.oliveyoung.ivmlite.sdk.dsl.deploy.DeployableContext
import com.oliveyoung.ivmlite.sdk.dsl.entity.*
import com.oliveyoung.ivmlite.sdk.execution.DeployExecutor
import com.oliveyoung.ivmlite.sdk.schema.Views
import com.oliveyoung.ivmlite.shared.domain.types.EntityKey
import com.oliveyoung.ivmlite.shared.domain.types.TenantId
import io.kotest.core.spec.style.StringSpec
import io.kotest.matchers.shouldBe
import io.kotest.matchers.shouldNotBe
import io.kotest.matchers.string.shouldContain
import io.ktor.server.testing.*
import org.koin.core.context.GlobalContext
import org.koin.core.context.stopKoin

/**
 * Real SDK DSL E2E Test (RFC-IMPL-011)
 *
 * 실제 SDK DSL을 사용한 E2E 테스트:
 * - ProductInput, BrandInput, CategoryInput DSL
 * - DeployableContext.deploy { ... }
 * - 내부 Workflow 직접 실행
 */
class RealSdkDslE2ETest : StringSpec({

    afterTest { stopKoin() }

    // ==================== 실제 SDK DSL 사용 ====================

    "Real SDK DSL: ProductInput → deploy → Query" {
        testApplication {
            application { module() }

            // Koin에서 Workflow 및 Repository 가져오기
            val koin = GlobalContext.get()
            val ingestWorkflow = koin.get<IngestWorkflow>()
            val slicingWorkflow = koin.get<SlicingWorkflow>()
            val outboxRepository = koin.get<OutboxRepositoryPort>()
            val queryViewWorkflow = koin.get<QueryViewWorkflow>()

            // DeployExecutor 생성 (실제 Workflow 연동)
            val executor = DeployExecutor(ingestWorkflow, slicingWorkflow, outboxRepository)

            // SDK DSL로 Product 입력 구성
            val productInput = ProductInput(
                tenantId = "sdk-dsl-tenant",
                sku = "SDK-DSL-001",
                name = "SDK DSL 테스트 상품",
                price = 29000,
                currency = "KRW",
                category = "SKINCARE",
                brand = "테스트브랜드",
                attributes = mapOf("color" to "red", "size" to "M")
            )

            val config = IvmClientConfig(
                baseUrl = "http://localhost:8080",
                tenantId = "sdk-dsl-tenant"
            )

            // DeployableContext 생성 (executor 주입)
            val context = DeployableContext(productInput, config, executor)

            // SDK DSL로 deploy 실행
            val result = context.deploy {
                compile.sync()
                ship.async {
                    opensearch {
                        index("products")
                    }
                }
                cutover.ready()
            }

            // 결과 검증
            result.success shouldBe true
            result.entityKey shouldContain "SDK-DSL-001"
            result.version shouldNotBe null

            // Query로 데이터 확인
            val queryResult = queryViewWorkflow.execute(
                tenantId = TenantId("sdk-dsl-tenant"),
                viewId = "view.product.pdp.v1",
                entityKey = EntityKey(result.entityKey),
                version = 1L
            )

            when (queryResult) {
                is QueryViewWorkflow.Result.Ok -> {
                    queryResult.value.data shouldContain "SDK DSL 테스트 상품"
                    queryResult.value.data shouldContain "29000"
                }
                is QueryViewWorkflow.Result.Err -> {
                    throw AssertionError("Query failed: ${queryResult.error}")
                }
            }
        }
    }

    "Real SDK DSL: deployNow shortcut" {
        testApplication {
            application { module() }

            val koin = GlobalContext.get()
            val ingestWorkflow = koin.get<IngestWorkflow>()
            val slicingWorkflow = koin.get<SlicingWorkflow>()
            val outboxRepository = koin.get<OutboxRepositoryPort>()
            val queryViewWorkflow = koin.get<QueryViewWorkflow>()

            val executor = DeployExecutor(ingestWorkflow, slicingWorkflow, outboxRepository)

            val productInput = ProductInput(
                tenantId = "sdk-shortcut-tenant",
                sku = "SHORTCUT-001",
                name = "Shortcut API 테스트",
                price = 15000
            )

            val config = IvmClientConfig(baseUrl = "http://localhost:8080", tenantId = "sdk-shortcut-tenant")
            val context = DeployableContext(productInput, config, executor)

            // deployNow shortcut 사용
            val result = context.deployNow {
                opensearch {
                    index("products")
                }
            }

            result.success shouldBe true
            result.entityKey shouldContain "SHORTCUT-001"

            // Query 검증
            val queryResult = queryViewWorkflow.execute(
                tenantId = TenantId("sdk-shortcut-tenant"),
                viewId = "view.product.pdp.v1",
                entityKey = EntityKey(result.entityKey),
                version = 1L
            )

            when (queryResult) {
                is QueryViewWorkflow.Result.Ok -> {
                    queryResult.value.data shouldContain "Shortcut API 테스트"
                }
                is QueryViewWorkflow.Result.Err -> {
                    throw AssertionError("Query failed: ${queryResult.error}")
                }
            }
        }
    }

    "Real SDK DSL: deployNowAndShipNow (동기 배포)" {
        testApplication {
            application { module() }
            // 애플리케이션 시작 대기
            runBlocking { kotlinx.coroutines.delay(100) }

            val koin = GlobalContext.get()
            val ingestWorkflow = koin.get<IngestWorkflow>()
            val slicingWorkflow = koin.get<SlicingWorkflow>()
            val outboxRepository = koin.get<OutboxRepositoryPort>()
            val queryViewWorkflow = koin.get<QueryViewWorkflow>()

            val executor = DeployExecutor(ingestWorkflow, slicingWorkflow, outboxRepository)

            val productInput = ProductInput(
                tenantId = "sdk-sync-tenant",
                sku = "SYNC-001",
                name = "완전 동기 배포 테스트",
                price = 50000
            )

            val config = IvmClientConfig(baseUrl = "http://localhost:8080", tenantId = "sdk-sync-tenant")
            val context = DeployableContext(productInput, config, executor)

            // deployNowAndShipNow: compile.sync + ship.sync
            val result = context.deployNowAndShipNow {
                opensearch { index("products") }
            }

            result.success shouldBe true
            result.entityKey shouldContain "SYNC-001"

            // Query 검증
            val queryResult = queryViewWorkflow.execute(
                tenantId = TenantId("sdk-sync-tenant"),
                viewId = "view.product.pdp.v1",
                entityKey = EntityKey(result.entityKey),
                version = 1L
            )

            when (queryResult) {
                is QueryViewWorkflow.Result.Ok -> {
                    queryResult.value.data shouldContain "완전 동기 배포 테스트"
                    queryResult.value.data shouldContain "50000"
                }
                is QueryViewWorkflow.Result.Err -> {
                    throw AssertionError("Query failed: ${queryResult.error}")
                }
            }
        }
    }

    "Real SDK DSL: Multiple Products batch deploy" {
        testApplication {
            application { module() }
            client.get("/health") // 애플리케이션 시작 강제

            val koin = GlobalContext.get()
            val ingestWorkflow = koin.get<IngestWorkflow>()
            val slicingWorkflow = koin.get<SlicingWorkflow>()
            val outboxRepository = koin.get<OutboxRepositoryPort>()
            val queryViewWorkflow = koin.get<QueryViewWorkflow>()

            val executor = DeployExecutor(ingestWorkflow, slicingWorkflow, outboxRepository)
            val config = IvmClientConfig(baseUrl = "http://localhost:8080", tenantId = "sdk-batch-dsl-tenant")

            // 3개 상품 배치 배포
            val results = (1..3).map { idx ->
                val productInput = ProductInput(
                    tenantId = "sdk-batch-dsl-tenant",
                    sku = "BATCH-DSL-${idx.toString().padStart(3, '0')}",
                    name = "배치 DSL 상품 #$idx",
                    price = 10000L + idx * 5000
                )

                val context = DeployableContext(productInput, config, executor)
                context.deployNow {
                    opensearch { index("products") }
                }
            }

            // 모든 배포 성공 확인
            results.forEach { result ->
                result.success shouldBe true
            }

            // 첫 번째 상품 Query 검증
            val queryResult = queryViewWorkflow.execute(
                tenantId = TenantId("sdk-batch-dsl-tenant"),
                viewId = "view.product.pdp.v1",
                entityKey = EntityKey(results[0].entityKey),
                version = 1L
            )

            when (queryResult) {
                is QueryViewWorkflow.Result.Ok -> {
                    queryResult.value.data shouldContain "배치 DSL 상품 #1"
                }
                is QueryViewWorkflow.Result.Err -> {
                    throw AssertionError("Query failed: ${queryResult.error}")
                }
            }
        }
    }

    "Real SDK DSL: Typed Query API (ViewRef)" {
        testApplication {
            application { module() }
            client.get("/health") // 애플리케이션 시작 강제

            val koin = GlobalContext.get()
            val ingestWorkflow = koin.get<IngestWorkflow>()
            val slicingWorkflow = koin.get<SlicingWorkflow>()
            val outboxRepository = koin.get<OutboxRepositoryPort>()

            val executor = DeployExecutor(ingestWorkflow, slicingWorkflow, outboxRepository)

            // SDK 설정
            Ivm.configure {
                // baseUrl("http://localhost:8080")
                // tenantId("sdk-query-tenant")
            }
            Ivm.setExecutor(executor)

            // 상품 배포
            val productInput = ProductInput(
                tenantId = "sdk-query-tenant",
                sku = "QUERY-001",
                name = "타입 세이프 Query 테스트 상품",
                price = 35000
            )

            val config = IvmClientConfig(baseUrl = "http://localhost:8080", tenantId = "sdk-query-tenant")
            val context = DeployableContext(productInput, config, executor)

            val result = context.deployNow {
                opensearch { index("products") }
            }

            result.success shouldBe true

            // TODO: Query API가 아직 구현되지 않았습니다
            // 타입 세이프 Query API 테스트
            // 방법 1: Ivm.query(Views.Product.pdp) - getRaw()로 ViewResult 반환
            // val view1 = Ivm.query(Views.Product.pdp)
            //     .key(result.entityKey)
            //     .getRaw()

            // TODO: ViewResult API 변경에 따라 수정 필요
            // view1.success shouldBe true
            // view1.data.toString() shouldContain "QUERY-001"
            // println("view1 = $view1")

            // 방법 2: Views.Product.pdp.query() - getRaw()로 ViewResult 반환
            // TODO: Query API 구현 후 활성화
            // val view2 = Views.Product.pdp.query()
            //     .key(result.entityKey)
            //     .get()
            // view2.success shouldBe true
            // view2.data.toString() shouldContain "타입 세이프 Query 테스트 상품"

            // TODO: 방법 3: Views.Product.pdp["key"] shortcut
            // val view3 = Views.Product.pdp[result.entityKey].get()
            // view3.success shouldBe true

            // TODO: 방법 4: 타입 세이프 버전 (파서 포함)
            // val typedResult = Views.Product.Pdp.typedQuery()
            //     .key(result.entityKey)
            //     .get()

            typedResult.success shouldBe true
            typedResult.data.toString() shouldContain "QUERY-001"
        }
    }
})
